@page "{workOrderId:int}"
@using Keswa.Pages.Reports
@model Keswa.Pages.Reports.WorkOrderCostingModel
@{
    ViewData["Title"] = "تقرير تكلفة أمر الشغل";
}

<div class="mb-4">
    <h1 class="h2 fw-bold">@ViewData["Title"]: @Model.WorkOrder.WorkOrderNumber</h1>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <div class="row pt-3">
            <div class="col-md-6">
                <h6 class="text-muted">بيانات الطلبية</h6>
                <dl class="row">
                    <dt class="col-sm-4">رقم الطلبية</dt>
                    @* --- هذا هو السطر الذي تم تصحيحه --- *@
                    <dd class="col-sm-8"><strong>@(Model.SalesOrder?.OrderNumber ?? "غير مرتبط بطلبية")</strong></dd>

                    <dt class="col-sm-4">العميل</dt>
                    <dd class="col-sm-8">@(Model.SalesOrder?.Customer?.Name ?? "-")</dd>

                    <dt class="col-sm-4">تاريخ الطلبية</dt>
                    <dd class="col-sm-8">@(Model.SalesOrder?.OrderDate.ToShortDateString() ?? "-")</dd>
                </dl>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted">ملخص أمر الشغل</h6>
                <dl class="row">
                    <dt class="col-sm-4">الموديل</dt>
                    <dd class="col-sm-8">@Model.WorkOrder.Product.Name</dd>

                    <dt class="col-sm-4">الكمية المطلوبة</dt>
                    <dd class="col-sm-8">@Model.WorkOrder.QuantityToProduce قطعة</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <form method="get">
            <input type="hidden" name="workOrderId" value="@Model.WorkOrder.Id" />
            <div class="row g-3 align-items-end">
                <div class="col-md-9">
                    <label class="form-label">اختر طريقة حساب تكلفة المواد الخام</label>
                    <select asp-for="SelectedCostingMethod" asp-items="Html.GetEnumSelectList<CostingMethod>()" class="form-select"></select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">تحديث التقرير</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-lg-7">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light">
                <h5 class="mb-0 fw-bold"><i class="bi bi-calculator-fill me-2"></i>ملخص التكاليف والربحية (@Model.SelectedCostingMethodDisplayName)</h5>
            </div>
            <div class="card-body p-4">
                <table class="table table-bordered fs-5">
                    <tbody>
                        <tr>
                            <td class="w-50"><i class="bi bi-box-seam me-2"></i>تكلفة المواد الخام</td>
                            <td class="text-end fw-bold">@Model.CostSummary.MaterialCost.ToString("N2") ج.م</td>
                        </tr>
                        <tr>
                            <td><i class="bi bi-people-fill me-2"></i>تكلفة أجور الخياطة (الفيه)</td>
                            <td class="text-end fw-bold">@Model.CostSummary.LaborCost.ToString("N2") ج.م</td>
                        </tr>
                        <tr class="table-secondary">
                            <td class="fw-bolder">إجمالي التكاليف المباشرة</td>
                            <td class="text-end fw-bolder">@Model.CostSummary.TotalDirectCost.ToString("N2") ج.م</td>
                        </tr>
                        <tr>
                            <td><i class="bi bi-cash-stack me-2"></i>الإيرادات (من طلبية البيع)</td>
                            <td class="text-end fw-bold text-success">@Model.CostSummary.Revenue.ToString("N2") ج.م</td>
                        </tr>
                        <tr class="table-primary">
                            <td class="fw-bolder">هامش الربح الإجمالي</td>
                            <td class="text-end fw-bolder">@Model.CostSummary.GrossProfit.ToString("N2") ج.م</td>
                        </tr>
                    </tbody>
                </table>

                <div class="mt-4 text-center">
                    <h6 class="text-muted">نسبة هامش الربح</h6>
                    @{
                        var profitMarginClass = Model.CostSummary.GrossProfitMargin >= 0 ? "text-success" : "text-danger";
                    }
                    <h2 class="display-5 fw-bold @profitMarginClass">@Model.CostSummary.GrossProfitMargin.ToString("F1")%</h2>
                </div>
            </div>
        </div>
    </div>
</div>