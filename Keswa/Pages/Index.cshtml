@page
@model IndexModel
@{
    ViewData["Title"] = "لوحة التحكم الرئيسية";
}

<style>
    /* --- ألوان احترافية جديدة --- */
    :root {
        --sw-blue: #3498db;
        --sw-purple: #8e44ad;
        --sw-green: #2ecc71;
        --sw-orange: #f39c12;
        --sw-asphalt: #34495e;
        --sw-silver: #bdc3c7;
    }

    .kpi-card {
        border-radius: 12px;
        color: white;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .kpi-card .card-title {
            font-weight: 500;
            font-size: 1rem;
            opacity: 0.9;
        }

        .kpi-card .card-value {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .kpi-card .card-icon {
            position: absolute;
            top: -10px;
            left: -20px;
            font-size: 6rem;
            opacity: 0.15;
            transform: rotate(-15deg);
        }

    /* --- تدرجات لونية احترافية --- */
    .bg-gradient-blue {
        background: linear-gradient(45deg, #2980b9, #3498db);
    }

    .bg-gradient-orange {
        background: linear-gradient(45deg, #d35400, #f39c12);
    }

    .bg-gradient-green {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
    }

    .dept-card .progress-bar {
        background-color: var(--sw-blue);
    }

    .flash-update {
        animation: flash 0.7s ease-out;
    }

    @@keyframes flash {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
            background-color: rgba(255, 255, 255, 0.2);
        }

        100% {
            transform: scale(1);
        }
    }
</style>

<div class="mb-4">
    <h1 class="h2 fw-bold">أهلاً بك، @Model.UserFullName</h1>
    <p class="text-muted">مؤشرات حيوية مباشرة من خط الإنتاج.</p>
</div>

<div class="row">
    <!-- --- الكروت الرئيسية --- -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card kpi-card bg-gradient-blue">
            <div class="card-body">
                <i class="bi bi-diagram-3 card-icon"></i>
                <h5 class="card-title">أوامر شغل مفتوحة</h5>
                <p class="card-value" id="activeWorkOrders">0</p>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card kpi-card bg-gradient-orange">
            <div class="card-body">
                <i class="bi bi-scissors card-icon"></i>
                <h5 class="card-title">قطع قيد الخياطة</h5>
                <p class="card-value" id="itemsInSewing">0</p>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card kpi-card bg-gradient-green">
            <div class="card-body">
                <i class="bi bi-check-all card-icon"></i>
                <h5 class="card-title">إنتاج اليوم (قطعة)</h5>
                <p class="card-value" id="producedToday">0</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- --- كارت قسم القص --- -->
    <div class="col-12 mb-4">
        <div class="card shadow-sm dept-card">
            <div class="card-header bg-light">
                <h5 class="mb-0 fw-bold"><i class="bi bi-rulers me-2"></i> قسم القص</h5>
            </div>
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <p class="text-muted mb-1">أوامر شغل حالية</p>
                        <h2 class="fw-bold mb-0" id="cuttingWOCount">0</h2>
                    </div>
                    <div class="col-md-6">
                        <p class="text-muted mb-1">نسبة الإنجاز</p>
                        <div class="progress" style="height: 25px;">
                            <div id="cuttingProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mt-3 mt-md-0">
                        <p class="text-muted mb-1">اكتمل / مطلوب</p>
                        <h4 class="fw-bold mb-0">
                            <span id="cuttingTotalCompleted">0</span> / <span id="cuttingTotalRequired">0</span>
                        </h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="~/lib/microsoft-signalr/signalr.min.js"></script>
    <script>
        $(document).ready(function () {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/dashboardHub")
                .build();

            function updateValue(elementId, newValue) {
                const element = $("#" + elementId);
                const currentValue = parseInt(element.text()) || 0;
                if (currentValue !== newValue) {
                    element.parent().addClass('flash-update');
                    element.text(newValue);
                    setTimeout(() => { element.parent().removeClass('flash-update'); }, 700);
                }
            }

            function updateProgressBar(barId, percentage) {
                const progressBar = $("#" + barId);
                progressBar.css("width", percentage + "%");
                progressBar.attr("aria-valuenow", percentage);
                progressBar.text(percentage + "%");
            }

            connection.on("ReceiveDashboardUpdate", function (data) {
                updateValue("activeWorkOrders", data.activeWorkOrders);
                updateValue("itemsInSewing", data.itemsInSewing);
                updateValue("producedToday", data.producedToday);

                if (data.cuttingSummary) {
                    updateValue("cuttingWOCount", data.cuttingSummary.workOrderCount);
                    updateValue("cuttingTotalCompleted", data.cuttingSummary.totalCompleted);
                    updateValue("cuttingTotalRequired", data.cuttingSummary.totalRequired);
                    updateProgressBar("cuttingProgressBar", data.cuttingSummary.progressPercentage);
                }
            });

            function startSignalR() {
                connection.start().catch(function (err) {
                    console.error('SignalR Connection Error: ', err.toString());
                    setTimeout(startSignalR, 5000);
                });
            }
            startSignalR();
        });
    </script>
}
